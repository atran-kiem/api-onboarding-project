<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Feathers Example</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@2.46.1/dist/full.css" rel="stylesheet" type="text/css" />
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2/dist/tailwind.min.css"
      rel="stylesheet"
      type="text/css"
    />
    <link rel="stylesheet" href="https://feathersjs.com/feathers-chat.css" />
  </head>
  <body data-theme="dracula">
    <main id="main" class="p-8">
      <h1 class="font-medium leading-tight text-5xl mt-0 mb-2">Welcome to Feathers</h1>

      <div class="form-control w-full py-2">
        <form class="input-group overflow-hidden" onsubmit="sendMessage(event)">
          <input name="message" id="message-text" type="text" class="input input-bordered w-full" />
          <button type="submit" class="btn">Send</button>
        </form>
      </div>
      <h2 class="pt-1 pb-2 text-lg">Messages</h2>
      <div id="messages-list" class="space-y-2"></div>
    </main>

    <script src="//unpkg.com/@feathersjs/client@^5.0.0/dist/feathers.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript">
      // Set up socket.io
      const socket = io('http://localhost:3030')
      // Initialize a Feathers app
      const app = feathers()

      // Register socket.io to talk to our server
      app.configure(feathers.socketio(socket))

      // Form submission handler that sends a new message
      async function sendMessage(event) {
        const messageInput = document.getElementById('message-text')

        event.preventDefault()

        if (!messageInput.value.trim()) {
          return
        }

        // Create a new message with the input field value
        await app.service('messages').create({
          text: messageInput.value
        })

        messageInput.value = ''
      }

      // Renders a single message on the page with edit and delete buttons
      function renderMessage(message) {
        const messagesList = document.getElementById('messages-list')
        const messageDiv = document.createElement('div')
        messageDiv.id = `message-${message.id}`
        messageDiv.className = 'card bg-base-200 shadow-md p-4'
        messageDiv.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <p class="text-lg">${escapeHtml(message.text)}</p>
              <p class="text-xs text-gray-500 mt-1">ID: ${message.id}</p>
            </div>
            <div class="flex gap-2 ml-4">
              <button onclick="editMessage(${message.id})" class="btn btn-sm btn-primary">Edit</button>
              <button onclick="deleteMessage(${message.id})" class="btn btn-sm btn-error">Delete</button>
            </div>
          </div>
          <div id="edit-form-${message.id}" class="hidden mt-2">
            <input type="text" id="edit-input-${message.id}" value="${escapeHtml(message.text)}" class="input input-bordered w-full mb-2" />
            <div class="flex gap-2">
              <button onclick="saveMessage(${message.id})" class="btn btn-sm btn-success">Save</button>
              <button onclick="cancelEdit(${message.id})" class="btn btn-sm btn-ghost">Cancel</button>
            </div>
          </div>
        `
        messagesList.appendChild(messageDiv)
      }

      // Escape HTML to prevent XSS
      function escapeHtml(text) {
        const div = document.createElement('div')
        div.textContent = text
        return div.innerHTML
      }

      // Add or update a message in the list
      function addOrUpdateMessage(message) {
        const existingMessage = document.getElementById(`message-${message.id}`)
        if (existingMessage) {
          existingMessage.remove()
        }
        renderMessage(message)
      }

      // Edit a message
      function editMessage(id) {
        const editForm = document.getElementById(`edit-form-${id}`)
        editForm.classList.remove('hidden')
      }

      // Cancel editing
      function cancelEdit(id) {
        const editForm = document.getElementById(`edit-form-${id}`)
        editForm.classList.add('hidden')
      }

      // Save edited message
      async function saveMessage(id) {
        const editInput = document.getElementById(`edit-input-${id}`)
        const newText = editInput.value.trim()
        
        if (!newText) {
          alert('Message text cannot be empty')
          return
        }

        try {
          // Use patch to partially update the message
          await app.service('messages').patch(id, {
            text: newText
          })
          cancelEdit(id)
        } catch (error) {
          alert('Error updating message: ' + error.message)
        }
      }

      // Delete a message
      async function deleteMessage(id) {
        if (!confirm('Are you sure you want to delete this message?')) {
          return
        }

        try {
          await app.service('messages').remove(id)
        } catch (error) {
          alert('Error deleting message: ' + error.message)
        }
      }

      // Remove message from DOM
      function removeMessage(id) {
        const messageElement = document.getElementById(`message-${id}`)
        if (messageElement) {
          messageElement.remove()
        }
      }

      const main = async () => {
        // Find all existing messages
        const messages = await app.service('messages').find()

        // Add existing messages to the list
        messages.forEach(renderMessage)

        // Listen for real-time events
        app.service('messages').on('created', addOrUpdateMessage)
        app.service('messages').on('updated', addOrUpdateMessage)
        app.service('messages').on('patched', addOrUpdateMessage)
        app.service('messages').on('removed', (message) => removeMessage(message.id))
      }

      main()
    </script>
  </body>
</html>